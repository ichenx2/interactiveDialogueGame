<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stock Prediction Game</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background-color: #2c3e50;
        color: #ecf0f1;
      }

      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
      }

      #startScreen,
      #gameScreen,
      #endScreen {
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 80%;
        max-width: 600px;
        margin: 0 auto;
      }

      h1 {
        text-align: center;
        color: #3498db;
      }

      .button {
        padding: 15px 30px;
        margin: 10px;
        border: none;
        border-radius: 5px;
        background-color: #3498db;
        color: #ecf0f1;
        cursor: pointer;
        transition: background-color 0.3s;
        font-size: 16px;
      }

      .button:hover {
        background-color: #2980b9;
      }

      #gameScreen {
        background-color: #34495e;
        padding: 20px;
        border-radius: 10px;
      }

      #messageForm {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
      }

      #messageInput {
        width: 70%;
        padding: 10px;
        margin-right: 10px;
        border: none;
        border-radius: 5px;
        background-color: #2c3e50;
        color: #ecf0f1;
      }

      #sendMessageBtn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: #3498db;
        color: #ecf0f1;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      #sendMessageBtn:hover {
        background-color: #2980b9;
      }

      #messages {
        width: 100%;
        background-color: #2c3e50;
        border-radius: 10px;
        padding: 10px;
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 20px;
      }

      .message {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }

      .userMessage {
        background-color: #16a085;
        color: #ecf0f1;
        text-align: right;
      }

      .botMessage {
        background-color: #3498db;
        color: #ecf0f1;
        text-align: left;
      }

      #sceneImage {
        text-align: center;
        margin-top: 20px;
      }

      #endScreen .button {
        font-size: 18px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div id="startScreen">
        <h1>Stock Prediction Game</h1>
        <button class="button" id="startButton">Start Game</button>
      </div>

      <div id="gameScreen">
        <h1>Game In Progress</h1>
        <div id="sceneImage"></div>
        <div id="messages"></div>
        <form id="messageForm">
          <input
            type="text"
            id="messageInput"
            placeholder="Type your message here..."
            required
          />
          <button id="sendMessageBtn" type="submit">Send</button>
        </form>
      </div>

      <div id="endScreen">
        <h1>Game Over</h1>
        <div id="finalMessage"></div>
        <button class="button" id="restartButton">Restart Game</button>
      </div>
    </div>

    <script>
            var conversationHistory = [];

            // 跳出一個視窗讓使用者輸入自己的API
            var apiKey = prompt("Please enter your api key");

            if (!apiKey) {
              alert("API key are required to start the game!");
            } else {
              document.getElementById("startScreen").style.display = "flex";

              document
                .getElementById("startButton")
                .addEventListener("click", function () {
                  startGame();
                });

              document
                .getElementById("restartButton")
                .addEventListener("click", function () {
                  location.reload();
                });

              document
                .getElementById("messageForm")
                .addEventListener("submit", function (event) {
                  event.preventDefault();
                  var message = document.getElementById("messageInput").value;

                  addToConversationHistory("user", message);
                  displayMessage(message, "user");

                  fetch(
                    "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=" +
                      apiKey,
                    {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                      },
                      body: JSON.stringify({
                        contents: conversationHistory,
                        safetySettings: [
                          {
                            category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                            threshold: "BLOCK_ONLY_HIGH",
                          },
                          {
                            category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                            threshold: "BLOCK_ONLY_HIGH",
                          },
                        ],
                        generationConfig: {
                          stopSequences: [""],
                          temperature: 1.0,
                          maxOutputTokens: 2048,
                          topP: 0.8,
                          topK: 10,
                        },
                      }),
                    }
                  )
                    .then((response) => response.json())
                    .then((data) => {
                      var responseText = data.candidates[0].content.parts[0].text;
                      addToConversationHistory("model", responseText);
                      displayMessage(responseText, "bot");
                      updateSceneImage(responseText);
                    })
                    .catch((error) => console.error("Error:", error));

                  document.getElementById("messageInput").value = "";
                });
            }

            function startGame() {
              document.getElementById("startScreen").style.display = "none";
              document.getElementById("gameScreen").style.display = "flex";

              conversationHistory.push({
                role: "user",
                parts: [
                  {
                    text: `腳本：
      """
      遊戲開始
      主持人：歡迎來到股票預測遊戲！您將有十萬元起始資金。我們會展示五則與股票相關的新聞事件，您需要判斷每則新聞會對該股票造成的影響，並決定是否投資。每題有兩個選項：A. 投資 B. 不投資。請注意，股票的漲跌並不一定與新聞事件有關。現在，開始遊戲吧！

      玩家資金：10萬元

      --------------------------------------------------------

      第一題
      主持人：第一題，請看以下新聞：

      新聞：某大型科技公司宣布推出新一代創新產品，市場反應熱烈。產品的獨特設計和新功能引起了廣泛關注，許多科技評論員對其給予高度評價。不過，也有一些市場分析師擔心這款產品的高定價可能會影響銷量。

      主持人：您認為這檔股票會漲還是會跌？請選擇：

      A. 投資
      B. 不投資

      請輸入您的選擇（A或B）：_____

      第一題結果
      主持人：（根據玩家選擇後）揭曉結果！該股票跌！

      如果玩家選擇A. 投資，則顯示：

      很可惜！您的投資虧損了2萬元。
      玩家資金：8萬元


      如果玩家選擇B. 不投資，則顯示：

      您避免了虧損，資金保持不變。
      玩家資金：10萬元

      --------------------------------------------------------

      第二題
      主持人：第二題，請看以下新聞：

      新聞：某知名企業的財務報表顯示本季度虧損嚴重，超出市場預期。公司高層表示，主要原因是由於一次性支出和新市場的擴展計劃。不過，公司也同時宣布了一項新的合作計劃，預計能在未來幾個季度帶來顯著收益。

      主持人：您認為這檔股票會漲還是會跌？請選擇：

      A. 投資
      B. 不投資

      請輸入您的選擇（A或B）：_____

      第二題結果
      主持人：（根據玩家選擇後）揭曉結果！該股票漲！

      如果玩家選擇A. 投資，則顯示：

      恭喜！您的投資獲利了2萬元。
      玩家資金：12萬元


      如果玩家選擇B. 不投資，則顯示：

      您錯失了賺錢的機會，資金保持不變。
      玩家資金：10萬元

      --------------------------------------------------------

      第三題
      主持人：第三題，請看以下新聞：

      新聞：全球經濟前景不明，市場波動加劇，多數股票受影響出現下跌趨勢。市場分析師建議投資者保持謹慎，等待形勢明朗後再做決定。

      主持人：您認為這檔股票會漲還是會跌？請選擇：

      A. 投資
      B. 不投資

      請輸入您的選擇（A或B）：_____

      第三題結果
      主持人：（根據玩家選擇後）揭曉結果！該股票跌！

      如果玩家選擇A. 投資，則顯示：

      很可惜！您的投資虧損了2萬元。
      玩家資金：8萬元


      如果玩家選擇B. 不投資，則顯示：

      您避免了虧損，資金保持不變。
      玩家資金：10萬元

      --------------------------------------------------------

      第四題
      主持人：第四題，請看以下新聞：

      新聞：某大型零售商宣布新的折扣計劃，吸引了大量顧客，公司預計這次折扣促銷將大幅提升本季度的銷售額。然而，有市場專家認為，過度依賴折扣策略可能會削弱品牌價值，影響長期收益。

      主持人：您認為這檔股票會漲還是會跌？請選擇：

      A. 投資
      B. 不投資

      請輸入您的選擇（A或B）：_____

      第四題結果
      主持人：（根據玩家選擇後）揭曉結果！該股票漲！

      如果玩家選擇A. 投資，則顯示：

      恭喜！您的投資獲利了2萬元。
      玩家資金：12萬元


      如果玩家選擇B. 不投資，則顯示：

      您錯失了賺錢的機會，資金保持不變。
      玩家資金：10萬元

      --------------------------------------------------------

      第五題
      主持人：最後一題，請看以下新聞：

      新聞：某國政府宣布實施新的貿易政策，旨在促進國內企業的發展。雖然政策細節尚未公開，但市場反應積極，預計這將為相關行業帶來利好消息。

      主持人：您認為這檔股票會漲還是會跌？請選擇：

      A. 投資
      B. 不投資

      請輸入您的選擇（A或B）：_____

      第五題結果
      主持人：（根據玩家選擇後）揭曉結果！該股票漲！

      如果玩家選擇A. 投資，則顯示：

      恭喜！您的投資獲利了2萬元。
      玩家資金：12萬元


      如果玩家選擇B. 不投資，則顯示：

      您錯失了賺錢的機會，資金保持不變。
      玩家資金：10萬元

      遊戲結束
      主持人：遊戲結束了！恭喜您完成了所有題目。您的最終資金是____。

      """
      `,
                  },
                ],
              });
            }

            function addToConversationHistory(role, text) {
              conversationHistory.push({
                role: role,
                parts: [{ text: text }],
              });
            }

            function displayMessage(text, sender) {
              var messageContainer = document.createElement("div");
              messageContainer.classList.add("message");
              messageContainer.classList.add(
                sender === "user" ? "userMessage" : "botMessage"
              );
              messageContainer.textContent = text;

              document.getElementById("messages").appendChild(messageContainer);
              document.getElementById("messages").scrollTop =
                document.getElementById("messages").scrollHeight;
            }

            function updateSceneImage(responseText) {
              // let sceneMatch = responseText.match(/新聞：(.*?)\s/); // 使用正則表達式匹配場景描述
              if (1) {
                // let scene = sceneMatch[1];
                // console.log(scene);
                // 檢查scene是否包含"科技公司"
                console.log(responseText.includes("科技公司"));
                if (responseText.includes("科技公司")) {
                  document.getElementById("sceneImage").innerHTML =
                    '<img src="./img/news1.png" alt="tech" style="width:500px;">';
                } else if (responseText.includes("財務報表")) {
                  document.getElementById("sceneImage").innerHTML =
                    '<img src="./img/news2.png" alt="FN" style="width:500px;">';
                } else if (responseText.includes("醫藥公司")) {
                  document.getElementById("sceneImage").innerHTML =
                    '<img src="./img/news3.png" alt="phr" style="width:500px;">';
                } else {
                  document.getElementById("sceneImage").innerHTML = ""; // 清空圖片
                }
              }

            function endGame(finalMessage) {
              document.getElementById("gameScreen").style.display = "none";
              document.getElementById("endScreen").style.display = "flex";
              document.getElementById("finalMessage").textContent = finalMessage;
            }
    </script>
  </body>
</html>
